package com.cgihosting.service.exploit;

import com.cgihosting.constantes.ConstantesGenerales;
import com.cgihosting.domain.application.CommandeDTO;
import com.cgihosting.domain.application.ServeurVirtuelDTO;
import com.cgihosting.domain.application.TraitementCommandeDTO;
import com.cgihosting.domain.application.TraitementServeurVirtuelDTO;
import com.cgihosting.outils.Dates;
import com.cgihosting.repository.CommandeRepository;
import com.cgihosting.repository.ServeurVirtuelRepository;
import com.cgihosting.repository.TraitementCommandeRepository;
import com.cgihosting.repository.TraitementServeurVirtuelRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * Created by marinib on 09/12/2016.
 */
@Service
public class GererCommandeServiceImpl implements GererCommandeService {

    /**
     * La balise autowired est indispensable
     */
    @Autowired
    private CommandeRepository commandeRepository;

    @Autowired
    private ServeurVirtuelRepository serveurVirtuelRepository;

    @Autowired
    private TraitementCommandeRepository traitementCommandeRepository;

    @Autowired
    private TraitementServeurVirtuelRepository traitementServeurVirtuelRepository;

    @Override
    public List<CommandeDTO> recupererCommandes() {

        List<CommandeDTO> commandeDTOListe = null;

        commandeDTOListe = (List<CommandeDTO>) commandeRepository.findAll();

        return commandeDTOListe;

    }



    @Override
    public List<CommandeDTO> recupererCommandesDPById(Integer idUser) {

        List<CommandeDTO> commandeDTOListe = null;

        commandeDTOListe = (List<CommandeDTO>) commandeRepository.findById(idUser);

        return commandeDTOListe;

    }


    @Override
    public List<CommandeDTO> recupererCommandesNonDPById(Integer idUser) {

        List<CommandeDTO> commandeDTOListe = null;

        commandeDTOListe = (List<CommandeDTO>) commandeRepository.findById(idUser);

        return commandeDTOListe;
    }


    @Override
    public CommandeDTO recupererCommandeById(Integer idCommande) {

        CommandeDTO commandeDTO = null;

        commandeDTO = commandeRepository.findById(idCommande);

        return commandeDTO;

    }


    @Override
    public int modifierCommande(CommandeDTO commandeDTO) {

        commandeRepository.save(commandeDTO);

        return commandeDTO.getId();
    }

    @Override
    public Long nombreTotalCommandes() {
        Long total;

        total = commandeRepository.count();
        return total;
    }

    @Override
    public Page<CommandeDTO> searchAllCommandeDTOPageByPage(Integer page, Integer ligneParPage) {

        Page<CommandeDTO> commandeDTOPage;


        commandeDTOPage = commandeRepository.findAll(new PageRequest(page,ligneParPage, new Sort(
                new Sort.Order(Sort.Direction.ASC, "id")
        )));
        return commandeDTOPage;
    }

    @Override
    public int creerCommande(ServeurVirtuelDTO serveurVirtuelDTO, Integer idUser) {

        // Objet commande
        CommandeDTO commandeDTO = new CommandeDTO();
        commandeDTO.setIdProjet(1);
        commandeDTO.setIdEnregistreur(idUser);

        commandeRepository.save(commandeDTO);

        // Etat traitement commande
        TraitementCommandeDTO traitementCommandeDTO = new TraitementCommandeDTO(commandeDTO.getId(),
                                                                                ConstantesGenerales.COMMANDE_ENREGISTREE,
                                                                                Dates.aujourdhui(),
                                                                                ConstantesGenerales.IND_OUI,
                                                                                idUser);

        traitementCommandeRepository.save(traitementCommandeDTO);

        // Serveur
        serveurVirtuelDTO.setIdCommande(commandeDTO.getId());
        serveurVirtuelDTO.setIdSolutionHebergement(1);
        serveurVirtuelRepository.save(serveurVirtuelDTO);

        TraitementServeurVirtuelDTO traitementServeurVirtuelDTO = new TraitementServeurVirtuelDTO(serveurVirtuelDTO.getId(),
                                                                                                 ConstantesGenerales.SERVEUR_VIRTUEL_ENREGISTRE,
                                                                                                 Dates.aujourdhui(),
                                                                                                ConstantesGenerales.IND_OUI,
                                                                                                idUser);

        traitementServeurVirtuelRepository.save(traitementServeurVirtuelDTO);




        return commandeDTO.getId();

    }

    @Override
    public Long nombreTotalCommandesByUtilisateur() {
        Long total;

        total = commandeRepository.count();
        return total;
    }

    @Override
    public Page<CommandeDTO> searchAllCommandeslDTOPageByPageByUser(Integer page, Integer ligneParPage, Integer userId) {
        Page<CommandeDTO> commandeDTOPage = null;
/*
        Specification<ServeurVirtuelDTO> rechercheCriteres = titleOrDescriptionContainsIgnoreCase(searchTerm);
        Page<ServeurVirtuelDTO> searchResultPage = serveurVirtuelRepository.findAll(searchSpec, pageRequest);
        return TodoMapper.mapEntityPageIntoDTOPage(pageRequest, searchResultPage);
        */

        return commandeDTOPage;

    }






}
