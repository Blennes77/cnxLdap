package com.cgihosting.controller.exploit.templateOS;

import com.cgihosting.constantes.ConstantesAdmin;
import com.cgihosting.constantes.ConstantesPage;
import com.cgihosting.domain.application.JournalDTO;
import com.cgihosting.domain.application.TemplateOSDTO;
import com.cgihosting.domain.application.UtilisateurDTO;
import com.cgihosting.formulaire.exploit.templateOS.AfficherTemplateOSFormulaire;
import com.cgihosting.formulaire.exploit.templateOS.DetailsTemplateOSFormulaire;
import com.cgihosting.objets.PaginationObjet;
import com.cgihosting.objets.UtilisateurSession;
import com.cgihosting.outils.Dates;
import com.cgihosting.service.admin.GererHebergeurService;
import com.cgihosting.service.admin.GererUtilisateurService;
import com.cgihosting.service.admin.JournaliserService;
import com.cgihosting.service.exploit.GererTemplateOSService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;

import javax.validation.Valid;

/**
 * Created by marinib on 07/01/2017.
 */
@Controller
public class TemplateOSController {


    /**
     * Méthodes controller
     * Le tag @controller permet à spring boot d'interpréter les
     * méthodes comme des controleurs
     */



    @Autowired
    private GererTemplateOSService gererTemplateOSService;

    @Autowired
    private JournaliserService journaliserService;


    @Autowired
    private GererHebergeurService gererHebergeurService;

    @Autowired
    private GererUtilisateurService gererUtilisateurService;


    @RequestMapping("/exploit/afficherTemplateOS")
    String afficherTemplateOS(@RequestParam(value = "page", required = false, defaultValue = "0") int page,
                              @RequestParam(value = "ligneParPage", required = false, defaultValue = "5") int ligneParPage,Model model){

        model.addAttribute(ConstantesPage.NOM_FORMULAIRE_HTML, recupererFormulaireAfficherTemplateOS(page, ligneParPage));
        return "exploit/templatesOS/afficherTemplateOS";
    }

    @RequestMapping(value = "/exploit/afficherDetailsTemplateOS", method = RequestMethod.POST)
    String affichageDetailsTemplateOS(int identifiantTemplateOSSelect, Model model){

        model.addAttribute(ConstantesPage.NOM_FORMULAIRE_HTML, recupererFormulaireDetailsTemplateOS(identifiantTemplateOSSelect));
        return "exploit/templatesOS/detailsTemplateOS";
    }


    @RequestMapping(value = "/exploit/modifierTemplateOS", method = RequestMethod.POST)

    String modifierTemplate(@Valid @ModelAttribute(ConstantesPage.NOM_FORMULAIRE_HTML)DetailsTemplateOSFormulaire detailsTemplateOSFormulaire,  BindingResult bindingResult, Model model, @RequestParam String action){

        int identifiantDonneeTraitee = 0;

        TemplateOSDTO templateOSDTO ;
        UtilisateurDTO utilisateurDTO;

        if (action.equals(ConstantesPage.ACTION_SAUVEGARDER)) {

            if (bindingResult.hasErrors()) {

            detailsTemplateOSFormulaire.setBoutonSoumissionLabel(ConstantesPage.EXPLOIT_DETAILS_TEMPLATES_OS_BOUTON_MODIFIER);

            detailsTemplateOSFormulaire.setTitrePage(ConstantesPage.EXPLOIT_DETAILS_TEMPLATES_OS_TITRE);
            detailsTemplateOSFormulaire.setBoutonRetourLabel(ConstantesPage.EXPLOIT_DETAILS_TEMPLATES_OS_BOUTON_RETOUR);

            model.addAttribute(ConstantesPage.NOM_FORMULAIRE_HTML, detailsTemplateOSFormulaire);


                return "exploit/templatesOS/detailsTemplateOS";
            }
            else{

                utilisateurDTO = gererUtilisateurService.searchUserByLogonName(UtilisateurSession.getLogin());

                templateOSDTO = detailsTemplateOSFormulaire.getTemplateOSDTO();

                templateOSDTO.setDateCreation(Dates.aujourdhui());
                templateOSDTO.setDateModification(Dates.aujourdhui());
                templateOSDTO.setIdCreateur(utilisateurDTO.getId());
                templateOSDTO.setIdModificateur(utilisateurDTO.getId());

                identifiantDonneeTraitee =  gererTemplateOSService.modifierTemplateOS(templateOSDTO);

                JournalDTO journalDTO = new JournalDTO(UtilisateurSession.getLogin(), ConstantesAdmin.JOURNAL_MODIFICATION_TEMPLATE,
                                                        identifiantDonneeTraitee, Dates.aujourdhui());
                journaliserService.enregistrerJournalisation(journalDTO);



                return  "redirect:/exploit/afficherTemplateOS";

            }

        }

        else {

            return  "redirect:/exploit/afficherTemplateOS";

        }


    }



    /**
     * Méthodes privées appelées par les controleurs pour
     * remplir les forumalires associés aux pages web
     * méthodes comme des controleurs
     */

    private AfficherTemplateOSFormulaire recupererFormulaireAfficherTemplateOS(int pageCourante, int numLigneAfficheParPage)  {


        AfficherTemplateOSFormulaire afficherTemplateOSFormulaire = new AfficherTemplateOSFormulaire();

        PaginationObjet paginationObjet;
        paginationObjet = new PaginationObjet(numLigneAfficheParPage, pageCourante, gererTemplateOSService.nombreTotalTemplateOS());
        afficherTemplateOSFormulaire.setPaginationObjet(paginationObjet);

        afficherTemplateOSFormulaire.setTemplateOSDTOPage(gererTemplateOSService.searchAllTemplateOSDTOPageByPage(pageCourante, numLigneAfficheParPage));


        afficherTemplateOSFormulaire.setTitrePage(ConstantesPage.EXPLOIT_AFFICHAGE_LISTE_TEMPLATES_OS_TITRE);
        afficherTemplateOSFormulaire.setBoutonSoumissionLabel(ConstantesPage.EXPLOIT_AFFICHAGE_LISTE_TEMPLATES_OS_BOUTON_AJOUTER);



        return afficherTemplateOSFormulaire;
    }



    /**
     * Méthodes privées appelées par les controleurs pour
     * remplir les forumalires associés aux pages web
     * méthodes comme des controleurs
     */

    private DetailsTemplateOSFormulaire recupererFormulaireDetailsTemplateOS(int identifiantTemplateOSSelect) {


        /** Attributs**/
        DetailsTemplateOSFormulaire detailsTemplateOSFormulaire = new DetailsTemplateOSFormulaire();
        TemplateOSDTO templateOSDTO = new TemplateOSDTO();
        String username;
        UtilisateurDTO utilisateurDTO;

        /** CODE **/


        utilisateurDTO = gererUtilisateurService.searchUserByLogonName(UtilisateurSession.getLogin());


        // SI identifiantTemplateOSSelect est non zéro, il s'agit d'une consultation sinon, c'est un ajout

        if (identifiantTemplateOSSelect != 0) {
            templateOSDTO = gererTemplateOSService.recupererTemplateOSById(identifiantTemplateOSSelect);

            detailsTemplateOSFormulaire.setBoutonSoumissionLabel(ConstantesPage.EXPLOIT_DETAILS_TEMPLATES_OS_BOUTON_MODIFIER);
        }
        else {

            templateOSDTO.setIdCreateur(utilisateurDTO.getId());

            templateOSDTO.setUtilisateurCreateurDTO(utilisateurDTO);
            templateOSDTO.setUtilisateurModificateurDTO(utilisateurDTO);


            detailsTemplateOSFormulaire.setBoutonSoumissionLabel(ConstantesPage.EXPLOIT_DETAILS_TEMPLATES_OS_BOUTON_AJOUTER);
        }

        templateOSDTO.setIdModificateur(utilisateurDTO.getId());
        detailsTemplateOSFormulaire.setTemplateOSDTO(templateOSDTO);

        detailsTemplateOSFormulaire.setReferentielHbergeurDTOListe(gererHebergeurService.recupererReferentielHebergeurs());
        detailsTemplateOSFormulaire.setTypeOSDTOListe(gererTemplateOSService.recupererReferentielOS());


        detailsTemplateOSFormulaire.setTitrePage(ConstantesPage.EXPLOIT_DETAILS_TEMPLATES_OS_TITRE);
        detailsTemplateOSFormulaire.setBoutonRetourLabel(ConstantesPage.EXPLOIT_DETAILS_TEMPLATES_OS_BOUTON_RETOUR);


        return detailsTemplateOSFormulaire;
    }


}
